# âœ… FINAL SNOWPARK CODE - Top 20 city-popular products NOT bought in last 6 months
# Uses: CUSTOMER_EXTERNAL_CODE, SKU_ERP_CODE, DEALER_CITY, WEEK_START_DATE, TOTAL_QUANTITY, TOTAL_DLP_VALUE

from snowflake.snowpark import Session
from snowflake.snowpark.functions import *
from snowflake.snowpark.types import StructType, StructField, IntegerType, StringType
import snowflake.snowpark.functions as F

# 1. SETUP - UPDATE YOUR CONNECTION PARAMS
connection_parameters = {
    "account": "<your_account>",
    "user": "<your_user>", 
    "password": "<your_password>",
    "warehouse": "<your_warehouse>",
    "database": "<your_database>",
    "schema": "<your_schema>"
}
session = Session.builder.configs(connection_parameters).create()

# 2. LOAD ORDERS - UPDATE TABLE NAME
orders_df = session.table("your_orders_table")  # REPLACE WITH YOUR TABLE NAME

# 3. LAST 6 MONTHS FILTER + SCORE
six_months_ago = (current_date() - 180).alias("cutoff_date")

recent_orders = orders_df.select(
    col("CUSTOMER_EXTERNAL_CODE").alias("customer_id"),
    col("SKU_ERP_CODE").alias("sku"), 
    col("TOTAL_QUANTITY"),
    col("TOTAL_DLP_VALUE"),
    col("DEALER_CITY").alias("city"),
    col("WEEK_START_DATE")
).filter(
    (col("TOTAL_QUANTITY") > 0) & 
    (col("TOTAL_DLP_VALUE") > 0) &
    (col("WEEK_START_DATE") >= col("cutoff_date")) &
    col("CUSTOMER_EXTERNAL_CODE").is_not_null() &
    col("SKU_ERP_CODE").is_not_null()
).with_column(
    "score", col("TOTAL_QUANTITY") * col("TOTAL_DLP_VALUE")
)

print(f"âœ… Recent orders (last 6 months): {recent_orders.count()} records")

# 4. TOP 20 POPULAR SKUs PER CITY
city_popular_skus = recent_orders.group_by("city", "sku").agg(
    sum_("score").alias("city_popularity_score"),
    count_distinct("customer_id").alias("city_buyers_count"),
    avg("score").alias("avg_score")
).with_column(
    "popularity_rank",
    row_number().over(Window.partition_by("city").order_by(desc("city_popularity_score"), desc("city_buyers_count")))
).filter(col("popularity_rank") <= 20)

print(f"âœ… Top 20 SKUs per city: {city_popular_skus.count()} records")
city_popular_skus.show(5)

# 5. CORE FUNCTION: Recommendations for ONE customer
def get_customer_recommendations(customer_id, city_name):
    """
    TOP 20 city-popular SKUs customer hasn't bought in last 6 months
    """
    # Customer's LAST 6 MONTHS purchases
    customer_recent_skus = recent_orders.filter(
        col("customer_id") == lit(customer_id)
    ).select("sku").distinct()
    
    # City TOP 20 excluding customer's purchases
    recommendations = city_popular_skus.filter(
        (col("city") == lit(city_name)) & 
        col("sku").notin(customer_recent_skus.select("sku"))
    ).select(
        col("sku"),
        col("city_popularity_score"),
        col("city_buyers_count"),
        col("avg_score"),
        lit(customer_id).alias("customer_id"),
        lit(city_name).alias("city"),
        lit("recommended").alias("recommendation_type")
    ).order_by(desc("city_popularity_score")).limit(20)
    
    return recommendations

# 6. TEST WITH REAL CUSTOMER (UPDATE THESE VALUES)
TEST_CUSTOMER_ID = "CUST12345"  # â† YOUR CUSTOMER_EXTERNAL_CODE
TEST_CITY = "Delhi"             # â† YOUR DEALER_CITY

print(f"
ðŸŽ¯ RECOMMENDATIONS for {TEST_CUSTOMER_ID} in {TEST_CITY}")
customer_recs = get_customer_recommendations(TEST_CUSTOMER_ID, TEST_CITY)
customer_recs.show(20)

# 7. BATCH ALL CUSTOMERS IN A CITY (OPTIONAL)
def batch_city_recommendations(city_name):
    """Recommendations for ALL customers in city"""
    city_customers = recent_orders.filter(col("city") == lit(city_name)).select("customer_id").distinct()
    
    all_recs = city_customers.alias("c").cross_join(
        city_popular_skus.filter(col("city") == lit(city_name)).alias("p")
    ).filter(
        col("c.customer_id").notin(
            recent_orders.filter(
                (col("city") == lit(city_name)) & 
                (col("sku") == col("p.sku"))
            ).select("customer_id")
        )
    ).select(
        col("c.customer_id"),
        col("p.sku"),
        col("p.city_popularity_score"),
        col("p.city_buyers_count")
    ).group_by("customer_id", "sku").agg(
        max("city_popularity_score").alias("score")
    ).with_column(
        "rank", row_number().over(Window.partition_by("customer_id").order_by(desc("score")))
    ).filter(col("rank") <= 20)
    
    return all_recs

# 8. SAVE RESULTS
customer_recs.write.mode("overwrite").save_as_table(f"RECS_{TEST_CUSTOMER_ID.replace('/', '_').replace(' ', '_')}")
print(f"âœ… SAVED to table: RECS_{TEST_CUSTOMER_ID}")

# Uncomment for batch city recommendations
# delhi_batch = batch_city_recommendations("Delhi")
# delhi_batch.write.mode("overwrite").save_as_table("BATCH_RECS_DELLI")

# 9. CLEANUP
session.close()
print("ðŸŽ‰ PIPELINE COMPLETE - Ready for Talverge!")
