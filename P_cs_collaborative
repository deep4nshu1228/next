# Complete Snowpark code: Top 20 city-popular products NOT bought by customer in last 6 months
from snowflake.snowpark import Session
from snowflake.snowpark.functions import *
from snowflake.snowpark.types import StructType, StructField, IntegerType, StringType
import snowflake.snowpark.functions as F
from datetime import datetime, timedelta

# 1. Setup Snowpark Session (UPDATE YOUR CONNECTION PARAMS)
connection_parameters = {
    "account": "<your_account>",
    "user": "<your_user>", 
    "password": "<your_password>",
    "warehouse": "<your_warehouse>",
    "database": "<your_database>",
    "schema": "<your_schema>"
}
session = Session.builder.configs(connection_parameters).create()

# 2. Load and prepare orders data (UPDATE TABLE NAME)
orders_df = session.table("your_orders_table")  # REPLACE WITH YOUR TABLE

# Calculate 6 months ago date
six_months_ago = (current_date() - 180).alias("six_months_ago")

# Clean and filter recent orders (last 6 months)
recent_orders = orders_df.select(
    col("CUSTOMER_EXTERNAL_CODE").alias("customer_id"),
    col("SKU_ERP_CODE").alias("product_id"), 
    col("TOTAL_QUANTITY"),
    col("TOTAL_DLP_VALUE"),
    col("DEALER_CITY").alias("city"),
    col("WEEK_START_DATE")
).filter(
    (col("TOTAL_QUANTITY") > 0) & 
    (col("TOTAL_DLP_VALUE") > 0) &
    (col("WEEK_START_DATE") >= six_months_ago) &
    col("customer_id").is_not_null() &
    col("product_id").is_not_null()
).with_column(
    "score", col("TOTAL_QUANTITY") * col("TOTAL_DLP_VALUE")
)

print(f"Recent orders (last 6 months): {recent_orders.count()}")

# 3. For each city: Get TOP 20 popular products
city_popular_products = recent_orders.group_by("city", "product_id").agg(
    sum_("score").alias("city_popularity_score"),
    count("customer_id").alias("city_buyers_count"),
    avg("score").alias("avg_score")
).with_column(
    "popularity_rank",
    row_number().over(
        Window.partition_by("city").order_by(desc("city_popularity_score"), desc("city_buyers_count"))
    )
).filter(col("popularity_rank") <= 20)

print(f"Top 20 products per city: {city_popular_products.count()}")

# 4. FUNCTION: Get recommendations for specific customer
def get_customer_recommendations(customer_id, city_name):
    """
    Returns TOP 20 city-popular products NOT bought by customer in last 6 months
    """
    # Customer's recent purchases
    customer_purchases = recent_orders.filter(
        col("customer_id") == lit(customer_id)
    ).select("product_id").distinct()
    
    # Top 20 popular in their city (excluding their purchases)
    city_top_products = city_popular_products.filter(
        (col("city") == lit(city_name)) & 
        (col("product_id").notin(customer_purchases.select("product_id")))
    ).select(
        col("product_id"),
        col("city_popularity_score"),
        col("city_buyers_count"),
        lit(customer_id).alias("recommended_for_customer"),
        lit(city_name).alias("city")
    ).order_by(desc("city_popularity_score")).limit(20)
    
    return city_top_products

# 5. EXAMPLE USAGE - Replace with actual customer_id and city
customer_id = "CUST12345"  # REPLACE WITH REAL CUSTOMER ID
customer_city = "Delhi"    # REPLACE WITH REAL CITY

recommendations = get_customer_recommendations(customer_id, customer_city)
print(f"
=== TOP 20 RECOMMENDATIONS for Customer {customer_id} in {customer_city} ===")
recommendations.select("product_id", "city_popularity_score", "city_buyers_count").show(20)

# 6. BATCH RECOMMENDATIONS for ALL customers in a city
def generate_city_batch_recommendations(city_name):
    """Generate recommendations for ALL customers in a city"""
    city_customers = recent_orders.filter(col("city") == lit(city_name)).select("customer_id").distinct()
    
    batch_recs = city_customers.cross_join(
        city_popular_products.filter(col("city") == lit(city_name))
    ).filter(
        col("customer_id").notin(
            recent_orders.filter(
                (col("city") == lit(city_name)) & 
                (col("product_id") == col("city_popular_products.product_id"))
            ).select("customer_id")
        )
    ).group_by("customer_id", "product_id").agg(
        max("city_popularity_score").alias("score")
    ).order_by(col("customer_id"), desc("score")).limit(20 * city_customers.count())
    
    return batch_recs

# Example batch for Delhi customers
# delhi_batch = generate_city_batch_recommendations("Delhi")
# delhi_batch.write.mode("overwrite").save_as_table("CUSTOMER_RECOMMENDATIONS_DELLI")

# 7. Save single customer recommendations
recommendations.write.mode("overwrite").save_as_table(f"RECS_{customer_id.replace(' ', '_')}")
print(f"Saved recommendations for {customer_id} to table: RECS_{customer_id}")

# Close session
session.close()
print("âœ… COMPLETE: City-popular product recommendations generated!")
