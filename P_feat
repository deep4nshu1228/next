from snowflake.snowpark.functions import row_number, col
from snowflake.snowpark.window import Window
import math

# Your existing setup (lines 1-7)
win_order = Window.partition_by(GROUP_KEYS).order_by(DATE_COL)
df = df.with_column("rn", row_number().over(win_order))
df.create_or_replace_temp_view("TEMP_DF")  # No extra load, in-memory only

# Configuration
HALFLIFE_LIST = [2, 4, 8, 12, 18, 26]

# Memory-efficient EMA calculation (replaces your lines 10-31)
for h in HALFLIFE_LIST:
    alpha = 1 - math.exp(math.log(0.5) / h)
    decay = 1 - alpha
    
    # Build GROUP_KEYS string for SQL
    group_keys_sql = ', '.join([f'"{k}"' for k in GROUP_KEYS])
    
    # EMA formula: weighted sum / sum of weights
    sql_query = f"""
        SELECT 
            *,
            COALESCE(
                SUM({TARGET} * POWER({decay}, rn - 1)) OVER (
                    PARTITION BY {group_keys_sql}
                    ORDER BY {DATE_COL}
                    ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
                ) / 
                NULLIF(
                    SUM(POWER({decay}, rn - 1)) OVER (
                        PARTITION BY {group_keys_sql}
                        ORDER BY {DATE_COL}
                        ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
                    ),
                    0
                ),
                0
            ) AS {TARGET}_ema_h{h}
        FROM TEMP_DF
    """
    
    # Execute and replace df
    df = df.session.sql(sql_query)
    df.create_or_replace_temp_view("TEMP_DF")

# Clean up row number column
df = df.drop("rn")

# Your existing downstream code continues here (line 32+)
# df is now ready with all EMA columns added
