import pandas as pd
import numpy as np
from datetime import datetime

# Load the data files
preprocessed_df = pd.read_excel('preprocessed.xlsx')
dispatch_agg = pd.read_excel('dispatch_agg.xlsx')  # Assuming this is your dispatch file name

# Convert date columns to datetime
preprocessed_df['DISPATCH_MONTH'] = pd.to_datetime(preprocessed_df['DISPATCH_MONTH'])
preprocessed_df['WARRANTY_MONTH'] = pd.to_datetime(preprocessed_df['WARRANTY_MONTH'])
dispatch_agg['DISPATCH_MONTH'] = pd.to_datetime(dispatch_agg['DISPATCH_MONTH'])

# Group warranty costs by BIKE_GROUPED, DISPATCH_MONTH, and WARRANTY_COST_TYPE
warranty_summary = preprocessed_df.groupby(
    ['BIKE_GROUPED', 'DISPATCH_MONTH', 'WARRANTY_COST_TYPE']
).agg({
    'WARRANTY_COST': 'sum'
}).reset_index()

# Pivot to get Actual and Predicted costs in separate columns
warranty_pivot = warranty_summary.pivot_table(
    index=['BIKE_GROUPED', 'DISPATCH_MONTH'],
    columns='WARRANTY_COST_TYPE',
    values='WARRANTY_COST',
    fill_value=0
).reset_index()

# Rename columns
warranty_pivot.columns.name = None
if 'Actual' in warranty_pivot.columns:
    warranty_pivot.rename(columns={'Actual': 'ACTUAL_COSTING'}, inplace=True)
else:
    warranty_pivot['ACTUAL_COSTING'] = 0

if 'Predicted' in warranty_pivot.columns:
    warranty_pivot.rename(columns={'Predicted': 'PRED_COSTING'}, inplace=True)
else:
    warranty_pivot['PRED_COSTING'] = 0

# Merge with dispatch volume data
final_df = pd.merge(
    dispatch_agg[['BIKE_GROUPED', 'DISPATCH_MONTH', 'VOLUME']],
    warranty_pivot,
    on=['BIKE_GROUPED', 'DISPATCH_MONTH'],
    how='left'
)

# Fill NaN values with 0 for warranty costs
final_df['ACTUAL_COSTING'] = final_df['ACTUAL_COSTING'].fillna(0)
final_df['PRED_COSTING'] = final_df['PRED_COSTING'].fillna(0)

# Calculate required fields
final_df['TOTAL_WARRANTY_COST'] = final_df['ACTUAL_COSTING'] + final_df['PRED_COSTING']
final_df['TOTAL_COST_PER_UNIT'] = final_df['TOTAL_WARRANTY_COST'] / final_df['VOLUME']
final_df['ACTUAL_COSTING_PER_UNIT'] = final_df['ACTUAL_COSTING'] / final_df['VOLUME']
final_df['PRED_COSTING_PER_UNIT'] = final_df['PRED_COSTING'] / final_df['VOLUME']

# Determine if warranty is Complete or Incomplete
final_df['INCOMPLETE_COMPLETE_WARRANTY'] = final_df.apply(
    lambda row: 'INCOMPLETE' if row['PRED_COSTING'] > 0 else 'COMPLETE',
    axis=1
)

# Replace inf values with 0 (in case of division by zero)
final_df.replace([np.inf, -np.inf], 0, inplace=True)

# Filter data starting from 2015-01-01
start_date = pd.to_datetime('2015-01-01')
final_df = final_df[final_df['DISPATCH_MONTH'] >= start_date].copy()

# Sort by BIKE_GROUPED and DISPATCH_MONTH
final_df = final_df.sort_values(['BIKE_GROUPED', 'DISPATCH_MONTH']).reset_index(drop=True)

# Calculate historical cumulative columns
final_df['HISTORICAL_VOLUME'] = final_df.groupby('BIKE_GROUPED')['VOLUME'].cumsum()
final_df['HISTORICAL_TOTAL_COST'] = final_df.groupby('BIKE_GROUPED')['TOTAL_WARRANTY_COST'].cumsum()
final_df['HISTORICAL_ACTUAL_COST'] = final_df.groupby('BIKE_GROUPED')['ACTUAL_COSTING'].cumsum()
final_df['HISTORICAL_PRED_COST'] = final_df.groupby('BIKE_GROUPED')['PRED_COSTING'].cumsum()

# Calculate historical per unit costs
final_df['HISTORICAL_TOTAL_COST_PER_UNIT'] = final_df['HISTORICAL_TOTAL_COST'] / final_df['HISTORICAL_VOLUME']
final_df['HISTORICAL_ACTUAL_COST_PER_UNIT'] = final_df['HISTORICAL_ACTUAL_COST'] / final_df['HISTORICAL_VOLUME']
final_df['HISTORICAL_PRED_COST_PER_UNIT'] = final_df['HISTORICAL_PRED_COST'] / final_df['HISTORICAL_VOLUME']

# Replace inf values with 0 (in case of division by zero)
final_df.replace([np.inf, -np.inf], 0, inplace=True)

# Select and order columns
final_df = final_df[[
    'DISPATCH_MONTH',
    'VOLUME',
    'TOTAL_WARRANTY_COST',
    'TOTAL_COST_PER_UNIT',
    'INCOMPLETE_COMPLETE_WARRANTY',
    'ACTUAL_COSTING',
    'ACTUAL_COSTING_PER_UNIT',
    'PRED_COSTING',
    'PRED_COSTING_PER_UNIT',
    'HISTORICAL_VOLUME',
    'HISTORICAL_TOTAL_COST',
    'HISTORICAL_TOTAL_COST_PER_UNIT',
    'HISTORICAL_ACTUAL_COST',
    'HISTORICAL_ACTUAL_COST_PER_UNIT',
    'HISTORICAL_PRED_COST',
    'HISTORICAL_PRED_COST_PER_UNIT',
    'BIKE_GROUPED'
]]

# Format DISPATCH_MONTH as mm-yyyy
final_df['DISPATCH_MONTH'] = final_df['DISPATCH_MONTH'].dt.strftime('%m-%Y')

# Get unique bike groups
bike_groups = final_df['BIKE_GROUPED'].unique()

# Create Excel writer object
output_filename = 'Warranty_Analysis_By_Bike.xlsx'
writer = pd.ExcelWriter(output_filename, engine='openpyxl')

# Write each bike group to a separate sheet
for bike_group in bike_groups:
    # Filter data for current bike group
    bike_df = final_df[final_df['BIKE_GROUPED'] == bike_group].copy()
    
    # Drop BIKE_GROUPED column as it's redundant in individual sheets
    bike_df = bike_df.drop('BIKE_GROUPED', axis=1)
    
    # Create valid sheet name (Excel has 31 char limit and some special chars are not allowed)
    sheet_name = str(bike_group)[:31]
    sheet_name = sheet_name.replace('/', '_').replace('\\', '_').replace('*', '_').replace('?', '_').replace('[', '_').replace(']', '_')
    
    # Write to Excel
    bike_df.to_excel(writer, sheet_name=sheet_name, index=False)
    
    print(f"Sheet created for: {bike_group} (Rows: {len(bike_df)})")

# Create a summary sheet with all data
final_df.to_excel(writer, sheet_name='All_Data', index=False)
print(f"
Summary sheet 'All_Data' created with {len(final_df)} rows")

# Save and close the writer
writer.close()

print(f"
✓ Analysis complete! File saved as: {output_filename}")
print(f"✓ Total sheets created: {len(bike_groups) + 1} ({len(bike_groups)} bike groups + 1 summary)")

# Display summary statistics
print("
" + "="*80)
print("SUMMARY STATISTICS BY BIKE GROUP")
print("="*80)

summary_stats = final_df.groupby('BIKE_GROUPED').agg({
    'VOLUME': 'sum',
    'TOTAL_WARRANTY_COST': 'sum',
    'ACTUAL_COSTING': 'sum',
    'PRED_COSTING': 'sum'
}).reset_index()

summary_stats['AVG_COST_PER_UNIT'] = summary_stats['TOTAL_WARRANTY_COST'] / summary_stats['VOLUME']
summary_stats = summary_stats.round(2)

print(summary_stats.to_string(index=False))

# Count incomplete vs complete warranties
print("
" + "="*80)
print("WARRANTY STATUS DISTRIBUTION")
print("="*80)

status_dist = final_df.groupby(['BIKE_GROUPED', 'INCOMPLETE_COMPLETE_WARRANTY']).size().reset_index(name='COUNT')
status_pivot = status_dist.pivot_table(
    index='BIKE_GROUPED',
    columns='INCOMPLETE_COMPLETE_WARRANTY',
    values='COUNT',
    fill_value=0
).reset_index()

print(status_pivot.to_string(index=False))
