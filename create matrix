import pandas as pd
import numpy as np

def create_matrix(df, ref_month, window=60):
    # Convert to period month
    df['DISPATCH_MONTH'] = pd.PeriodIndex(df['DISPATCH_MONTH'], freq='M')
    df['WARRANTY_MONTH'] = pd.PeriodIndex(df['WARRANTY_MONTH'], freq='M')
    ref = pd.Period(ref_month, freq='M')
    dispatch_range = [ref - i for i in reversed(range(window))]
    warranty_range = [ref + i for i in range(window)]
    matrix = pd.DataFrame(index=dispatch_range, columns=warranty_range, dtype=float)
    for d in dispatch_range:
        for w in warranty_range:
            mask = (df['DISPATCH_MONTH'] == d) & (df['WARRANTY_MONTH'] == w)
            matrix.at[d, w] = df.loc[mask, 'WARRANTY_COST'].sum() if mask.any() else np.nan
    return matrix

# For multiple reference months and Excel output
ref_months = ['2023-01', '2023-02'] # example; add your reference months
writer = pd.ExcelWriter('output.xlsx', engine='openpyxl')
for ref in ref_months:
    mx = create_matrix(df, ref)
    mx.to_excel(writer, sheet_name=str(ref))
writer.save()
