import pandas as pd
import numpy as np

def create_matrix(df, ref_month, window=60):
    # Convert to period month
    df['DISPATCH_MONTH'] = pd.PeriodIndex(df['DISPATCH_MONTH'], freq='M')
    df['WARRANTY_MONTH'] = pd.PeriodIndex(df['WARRANTY_MONTH'], freq='M')
    ref = pd.Period(ref_month, freq='M')
    dispatch_range = [ref - i for i in reversed(range(window))]
    warranty_range = [ref + i for i in range(window)]
    matrix = pd.DataFrame(index=dispatch_range, columns=warranty_range, dtype=float)
    for d in dispatch_range:
        for w in warranty_range:
            mask = (df['DISPATCH_MONTH'] == d) & (df['WARRANTY_MONTH'] == w)
            matrix.at[d, w] = df.loc[mask, 'WARRANTY_COST'].sum() if mask.any() else np.nan
    return matrix

# For multiple reference months and Excel output
ref_months = ['2023-01', '2023-02'] # example; add your reference months
writer = pd.ExcelWriter('output.xlsx', engine='openpyxl')
for ref in ref_months:
    mx = create_matrix(df, ref)
    mx.to_excel(writer, sheet_name=str(ref))
writer.save()







import pandas as pd
import numpy as np

def warranty_group_summary(df, ref_months, window_dispatch=60, window_warranty=60, group_size=12):
    df['DISPATCH_MONTH'] = pd.PeriodIndex(df['DISPATCH_MONTH'], freq='M')
    df['WARRANTY_MONTH'] = pd.PeriodIndex(df['WARRANTY_MONTH'], freq='M')
    results = []
    for ref_str in ref_months:
        ref = pd.Period(ref_str, freq='M')
        # Last 60 dispatch months (excluding ref)
        dispatch_range = [ref - i for i in range(1, window_dispatch + 1)]
        # Next 60 warranty months starting at ref
        warranty_range = [ref + i for i in range(window_warranty)]
        # Group warranty months into intervals of 12
        warranty_groups = [warranty_range[i:i+group_size] for i in range(0, window_warranty, group_size)]
        # Aggregate cost for each interval
        group_sums = []
        for g in warranty_groups:
            mask = (df['DISPATCH_MONTH'].isin(dispatch_range)) & (df['WARRANTY_MONTH'].isin(g))
            group_sums.append(df.loc[mask, 'WARRANTY_COST'].sum())
        results.append(group_sums)
    # Prepare DataFrame for output
    interval_labels = [f"Month {i*group_size+1}-{(i+1)*group_size}" for i in range(len(warranty_groups))]
    summary_df = pd.DataFrame(results, index=ref_months, columns=interval_labels)
    return summary_df

# Usage:
ref_months = ['2023-01', '2023-02']  # Your reference months
summary_df = warranty_group_summary(df, ref_months)
summary_df.to_excel('warranty_group_summary.xlsx')

