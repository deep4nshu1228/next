import pandas as pd

# 1) Build pivot (if not already)
df["WARRANTY_CLAIM_DATE"] = pd.to_datetime(df["WARRANTY_CLAIM_DATE"], errors="coerce")
df["WARRANTY_COST"] = pd.to_numeric(df["WARRANTY_COST"], errors="coerce")
df["warranty_month"] = df["WARRANTY_CLAIM_DATE"].dt.to_period("M")

pivot = pd.pivot_table(
    df,
    index="BIKE_GROUPED",
    columns="warranty_month",       # PeriodIndex columns
    values="WARRANTY_COST",
    aggfunc="sum",
    fill_value=0
)

# 2) Sort columns chronologically and add row_total
pivot = pivot.sort_index(axis=1)
pivot["row_total"] = pivot.sum(axis=1)
# Move row_total to the end
pivot = pivot[[c for c in pivot.columns if c != "row_total"] + ["row_total"]]

# 3) Relabel columns mm-YYYY (keep row_total as is)
pivot.columns = [
    c.strftime("%m-%Y") if hasattr(c, "strftime") else str(c)
    for c in pivot.columns
]

# 4) Save
pivot.to_csv("pivot_warranty_cost_by_model_family_month_sorted.csv")
